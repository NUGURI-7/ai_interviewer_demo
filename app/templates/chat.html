<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI é¢è¯•å®˜</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
</head>
<body class="bg-gradient-to-br from-indigo-100 to-white min-h-screen flex flex-col items-center justify-between">

  <!-- Header -->
  <header class="w-full bg-indigo-600 text-white py-4 shadow-md text-center">
    <h1 class="text-2xl font-bold">ğŸ§  AI é¢è¯•å®˜</h1>
    <p class="text-sm text-indigo-200">æ™ºèƒ½é—®ç­” Â· è½»æ¾ç»ƒä¹  Â· å®æˆ˜æ¨¡æ‹Ÿ</p>
  </header>

  <!-- Chat Container -->
  <main class="w-full max-w-3xl flex-1 overflow-y-auto px-4 py-6 space-y-4" id="chat-box">
    <!-- è¿™æ˜¯ç”¨æ¥å±•ç¤º AI å›å¤çš„åŒºåŸŸ -->
    <div id="ai-response" class="prose max-w-none mt-4 p-4 bg-gray-100 rounded-xl"></div>

   
    <!-- åŠ¨æ€æ’å…¥æ¶ˆæ¯ -->
  </main>

  <!-- Footer -->
  <footer class="w-full max-w-3xl bg-white border-t px-4 py-3 flex items-center gap-2">
    <textarea
        id="answer-input"
        rows="1"
        oninput="autoResize(this)"
        class="flex-1 border border-gray-300 rounded-xl px-4 py-2 text-base focus:outline-none focus:ring-2 focus:ring-indigo-400 shadow-sm resize-none overflow-hidden"
        placeholder="è¾“å…¥ä½ çš„å›ç­”ï¼ŒæŒ‰ Enter æˆ–ç‚¹å‡»å‘é€..."
    ></textarea>
  
    <!-- è¯­éŸ³å½•å…¥æŒ‰é’® -->
    <button id="start-record-btn" onclick="startListening()" class="bg-green-600 text-white px-4 py-2 rounded-xl ml-2">ğŸ™ï¸ å¼€å§‹å½•éŸ³</button>
    <button id="stop-record-btn" onclick="stopListening()" class="bg-red-600 text-white px-4 py-2 rounded-xl ml-2 hidden">ğŸ›‘ åœæ­¢</button>
    <span id="record-time" class="ml-2 text-sm text-gray-500 hidden"></span>
  
    <button
      onclick="sendMessage()"
      class="bg-indigo-600 text-white px-5 py-2 rounded-xl font-medium shadow hover:bg-indigo-700 transition"
    >
      å‘é€
    </button>
  </footer>
  
  
  
  <!-- JS Logic -->
  <script>
    let recognition = null;
    let startTime = null;
    let timerInterval = null;
    let finalTranscript = '';

  function startListening() {
    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'zh-CN';
    recognition.continuous = true;
    recognition.interimResults = false;
    finalTranscript = '';

    // UIå˜åŒ–
    document.getElementById('start-record-btn').style.display = 'none';
    document.getElementById('stop-record-btn').style.display = 'inline-flex';
    document.getElementById('record-time').classList.remove('hidden');

    // å¼€å§‹è®¡æ—¶
    startTime = Date.now();
    timerInterval = setInterval(() => {
      const seconds = Math.floor((Date.now() - startTime) / 1000);
      document.getElementById('record-time').textContent = `å½•éŸ³ä¸­ï¼š${seconds} ç§’`;
    }, 1000);

    recognition.onstart = function () {
      console.log("è¯­éŸ³è¯†åˆ«å·²å¯åŠ¨");
    };

    recognition.onresult = function (event) {
        let finalTranscript = "";
        for (let i = event.resultIndex; i < event.results.length; ++i) {
            if (event.results[i].isFinal) {
                finalTranscript += event.results[i][0].transcript;
            }
        }
        const input = document.getElementById('answer-input');
        input.value += finalTranscript;
        autoResize(input);
        // document.getElementById('answer-input').value += finalTranscript;
    };

    recognition.onerror = function (event) {
      alert("è¯­éŸ³è¯†åˆ«é”™è¯¯ï¼š" + event.error);
    };

    recognition.onend = function () {
      stopUI();
    };

    recognition.start();
  }

  function stopListening() {
    if (recognition) {
      recognition.stop();
    }
  }

  function stopUI() {
    clearInterval(timerInterval);
    document.getElementById('start-record-btn').style.display = 'inline-flex';
    document.getElementById('stop-record-btn').style.display = 'none';
    document.getElementById('record-time').classList.add('hidden');
    document.getElementById('record-time').textContent = "";
  }

  function sendMessage() {
    const input = document.getElementById("answer-input");
    const message = input.value.trim();
    if (message !== "") {
      socket.emit("user_message", { message: message });
      input.value = "";
    }
  }

  function autoResize(textarea) {
  textarea.style.height = 'auto';  // é‡ç½®é«˜åº¦
  textarea.style.height = textarea.scrollHeight + 'px';  // è®¾ç½®ä¸ºå†…å®¹é«˜åº¦
}

function showAIReply(markdownText) {
  const html = marked.parse(markdownText);
  document.getElementById("ai-response").innerHTML = html;
}


    const socket = io();
    let usedIds = [];
    let prevQuestionId = null;
    const chatBox = document.getElementById("chat-box");

    function appendMessage(sender, text) {
      const wrapper = document.createElement("div");
      wrapper.className = `flex items-start space-x-2 ${
        sender === "bot" ? "justify-start" : "justify-end"
      }`;

      const bubble = document.createElement("div");
      bubble.className = `rounded-xl px-4 py-2 text-base shadow max-w-[75%] ${
        sender === "bot"
          ? "bg-white text-gray-800 border border-gray-200"
          : "bg-indigo-600 text-white"
      }`;

      const avatar = document.createElement("div");
      avatar.className = "w-8 h-8 rounded-full bg-indigo-500 text-white flex items-center justify-center font-bold text-sm";
      avatar.textContent = sender === "bot" ? "AI" : "ä½ ";

      bubble.innerHTML = marked.parse(text);
      wrapper.appendChild(sender === "bot" ? avatar : bubble);
      wrapper.appendChild(sender === "bot" ? bubble : avatar);

      chatBox.appendChild(wrapper);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    socket.on("connect", function () {
      socket.emit("user_message", {
        message: "",
        prev_question_id: null,
        used_ids: [],
      });
    });

    socket.on("bot_message", function (data) {
      appendMessage("bot", `<strong>ç³»ç»Ÿæç¤ºï¼š</strong> ${data.evaluation}`);
      appendMessage("bot", `<strong>é—®é¢˜ï¼š</strong> ${data.next_question}`);
      prevQuestionId = data.next_question_id;
      usedIds.push(data.next_question_id);
    });

    socket.on("bot_response", function (data) {
      appendMessage("bot", `<strong>è¯„ä»·ï¼š</strong> ${data.evaluation}`);
      appendMessage("bot", `<strong>é—®é¢˜ï¼š</strong> ${data.next_question}`);
      prevQuestionId = data.next_question_id;
      usedIds.push(data.next_question_id);
    });

    socket.on("ai_reply", function (data) {
        const replyText = data.reply; // åç«¯è¿”å›çš„ markdown å†…å®¹
        showAIReply(replyText); // ç”¨ marked æ¸²æŸ“å¹¶æ˜¾ç¤º
    });


    function sendMessage() {
      const input = document.getElementById("answer-input");
      const msg = input.value.trim();
      if (!msg) return;
      appendMessage("user", msg);
      socket.emit("user_message", {
        message: msg,
        prev_question_id: prevQuestionId,
        used_ids: usedIds,
      });
      input.value = "";
      autoResize(input); // è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
    }

    

    document.getElementById("answer-input").addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        sendMessage();
      }
    });
  </script>
</body>
</html>
